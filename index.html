
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="The best way to prevent hating your job when your company grows is to use the Apple provided localization tools from day one, even if you have no &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://raylillywhite.github.com/raylillywhitehtblog/">
  <link href="/raylillywhitehtblog/favicon.png" rel="icon">
  <link href="/raylillywhitehtblog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/raylillywhitehtblog/javascripts/modernizr-2.0.js"></script>
  <script src="/raylillywhitehtblog/javascripts/ender.js"></script>
  <script src="/raylillywhitehtblog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/raylillywhitehtblog/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:raylillywhite.github.com/raylillywhitehtblog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/raylillywhitehtblog/">Blog</a></li>
  <li><a href="/raylillywhitehtblog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/blog/2013/02/18/the-nitty-gritty-of-ios-internationalization-and-localization/">The Nitty Gritty of iOS Internationalization and Localization</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-18T22:30:00-08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The best way to prevent hating your job when your company grows is to use the Apple provided localization tools from day one, even if you have no plans to localize your app. Maybe it&#8217;s not the best way, but it&#8217;s certainly required. From day one you should be using:</p>

<ul>
<li><code>NSNumberFormatter</code></li>
<li><code>NSDateFormatter</code></li>
<li><code>NSLocalizedString</code></li>
<li><code>[[NSLocale currentLocale] objectForKey:NSLocaleUsesMetricSystem]</code></li>
</ul>


<p>From day one, you should not be:</p>

<ul>
<li>Pluralizing by adding an &#8216;s&#8217; (Safe yourself some trouble and use separate localized strings for plural and singular nouns)</li>
<li>Using magic numbers to set static sizes for views (specifically views with text)</li>
<li>Using &#8216;$&#8217; or other currency symbols in string formats</li>
</ul>


<p>Let&#8217;s start with the easier ones.</p>

<h2>NSNumberFormatter</h2>

<p>NSNumberFormatter&#8217;s most important use in localization for us was with displaying currencies. Users will have a different expectation of how a given currency is displayed depending on what country they are from. A price in US Dollars could be shown as <code>$50.00</code>, <code>US$50.00</code>, <code>50,00 $US</code>, etc.</p>

<p>NSNumberFormatter&#8217;s <code>NSNumberFormatterCurrencyStyle</code> allows you to let Apple decide which one to show the user, which gives them a consistent experience across all of their apps. Showing the full currency code (USD) would also work, and may be useful for certain detailed views like a verbose receipt, but we chose to stick with the more minimal format that NSNumberFormatter provides.
Example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSNumberFormatter</span> <span class="o">*</span><span class="n">currencyFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSNumberFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setNumberStyle:</span><span class="n">NSNumberFormatterCurrencyStyle</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setCurrencyCode:</span><span class="n">currencyCode</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setMaximumFractionDigits:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setRoundingMode:</span><span class="n">NSNumberFormatterRoundHalfUp</span><span class="p">];</span>
</span><span class='line'><span class="k">return</span> <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">stringFromNumber:</span><span class="err">@</span><span class="p">(</span><span class="n">amount</span><span class="p">)];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Even if you aren&#8217;t displaying prices, make sure to use NSNumberFormatter to ensure that large numbers and decimals are displayed to the user correctly. <code>,</code> and <code>.</code> are switched in other locales.</p>

<h3>Caching and Thread Safety</h3>

<p>NSNumberFormatters and NSDateFormatters are slow to initialize and configure, so you generally want to cache any formatters that you can use in multiple places. Unfortunately they aren&#8217;t thread-safe though, so we keep separate formatters per thread:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="nf">HTCurrencyString</span><span class="p">(</span><span class="kt">double</span> <span class="n">amount</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">currencyCode</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">currencyFormatterKey</span> <span class="o">=</span> <span class="s">@&quot;HTCurrencyFormatter&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSNumberFormatter</span> <span class="o">*</span><span class="n">currencyFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">]</span> <span class="n">threadDictionary</span><span class="p">][</span><span class="n">currencyFormatterKey</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">currencyFormatter</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">currencyFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSNumberFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setNumberStyle:</span><span class="n">NSNumberFormatterCurrencyStyle</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setLocale:</span><span class="p">[</span><span class="n">NSLocale</span> <span class="n">currentLocale</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">]</span> <span class="n">threadDictionary</span><span class="p">][</span><span class="n">currencyFormatterKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">currencyFormatter</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setCurrencyCode:</span><span class="n">currencyCode</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setMaximumFractionDigits:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">setRoundingMode:</span><span class="n">NSNumberFormatterRoundHalfUp</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">currencyFormatter</span> <span class="nl">stringFromNumber:</span><span class="err">@</span><span class="p">(</span><span class="n">amount</span><span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>NSDateFormatter</h2>

<p>Using date formatters involves a couple of additional tricks, beyond the caching necessary for both date and number formatters. There are many built-in date formatter styles that we made use of with cached formatters like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSDateFormatter</span> <span class="o">*</span><span class="nf">HTMediumDateFormatter</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">mediumDateFormatterKey</span> <span class="o">=</span> <span class="s">@&quot;HTMediumDateFormatter&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">dateFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">]</span> <span class="n">threadDictionary</span><span class="p">][</span><span class="n">mediumDateFormatterKey</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dateFormatter</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">dateFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">dateFormatter</span> <span class="nl">setDateStyle:</span><span class="n">NSDateFormatterMediumStyle</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">]</span> <span class="n">threadDictionary</span><span class="p">][</span><span class="n">mediumDateFormatterKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dateFormatter</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">dateFormatter</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But there were also cases that weren&#8217;t really covered by the built-in styles, such as the date format that we prefer on our checkout screen, &#8220;Mon, Jan 28&#8221;. We previously were showing that by setting the date format with the string &#8220;EEE, MMM d&#8221;. This format doesn&#8217;t make sense for other countries though. We thought we would have to revert to using one of the built-in styles, but we found a very helpful method that Apple added in iOS 4.0: <code>+[NSDateFormatter dateFormatFromTemplate:options:locale:]</code>. That method will take the components of a date that you want, such as an abbreviated weekday, an abbreviated month and a day, and create a format string that suites the given locale.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="p">[</span><span class="n">_dateFormatter</span> <span class="nl">setDateFormat:</span><span class="p">[</span><span class="n">NSDateFormatter</span> <span class="nl">dateFormatFromTemplate:</span><span class="s">@&quot;EEEMMMd&quot;</span>
</span><span class='line'>                                                                  <span class="nl">options:</span><span class="mi">0</span>
</span><span class='line'>                                                                   <span class="nl">locale:</span><span class="p">[</span><span class="n">NSLocale</span> <span class="n">currentLocale</span><span class="p">]]];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Depending on the user&#8217;s locale, that date formatter will give you strings like the following:</p>

<ul>
<li>US: <code>Mon, Jan 28</code></li>
<li>UK: <code>Mon 28 Jan</code></li>
<li>FR: <code>lun. 28 janv.</code></li>
</ul>


<p>Way easier and more reliable than trying to manipulate the built-in formats into the one that you&#8217;re looking for ;)  If you go through your app and replace your hardcoded date formats using this method, be careful not to don&#8217;t replace any date formats that you&#8217;re using for parsing.</p>

<h3>Date Formatter Gotcha</h3>

<p>When using a date formatter to parse dates from an API, make sure to set the locale to <code>@"en_US_POSIX"</code> for consistent behavior across devices/users.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSDateFormatter</span> <span class="o">*</span><span class="nf">HTRFC822DateFormatter</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">rfc822DateFormatterKey</span> <span class="o">=</span> <span class="s">@&quot;HTRFC822DateFormatter&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">dateFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">]</span> <span class="n">threadDictionary</span><span class="p">][</span><span class="n">rfc822DateFormatterKey</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">dateFormatter</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">dateFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">dateFormatter</span> <span class="nl">setLocale:</span><span class="p">[[</span><span class="n">NSLocale</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithLocaleIdentifier:</span><span class="s">@&quot;en_US_POSIX&quot;</span><span class="p">]];</span>
</span><span class='line'>        <span class="n">dateFormatter</span><span class="p">.</span><span class="n">dateFormat</span> <span class="o">=</span> <span class="s">@&quot;EEE, dd MMM yyyy HH:mm:ss ZZZ&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">]</span> <span class="n">threadDictionary</span><span class="p">][</span><span class="n">rfc822DateFormatterKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dateFormatter</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">dateFormatter</span><span class="p">.</span><span class="n">timeZone</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimeZone</span> <span class="n">systemTimeZone</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">dateFormatter</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://developer.apple.com/library/ios/#qa/qa1480/_index.html">More information on this from Apple</a></p>

<h2>NSLocalizedString</h2>

<p>The most important part of localization: user facing strings. Apple provides NSLocalizedString to wrap any string or format that you&#8217;ll be displaying to the user. <a href="http://twitter.com/mattt">@Mattt</a> has a <a href="http://nshipster.com/nslocalizedstring/">great article about NSLocalizedString on NSHipster</a>, so instead of going into detail about it here, I&#8217;m just going to describe some things that we did differently, so that you can decide if you&#8217;d want to do something similar.</p>

<p>As Mattt pointed out, the most common NSLocalizedString method is <code>NSString *NSLocalizedString(NSString *key, NSString *comment)</code>.  The basic behavior of that is to lookup the key in a <code>.strings</code> file that matches the preferred language of the user. We chose to use <code>NSLocalizedStringWithDefaultValue</code> though, because <code>NSLocalizedString(key, comment)</code> leaves you two straight-forward options:</p>

<ol>
<li><p>Use an English strings file (<code>en.lproj/Localizable.strings</code>) to map your keys to english strings. This means that your code no longer shows your english strings in context. That will increase the amount of jumping between files that you need to do, and can cause confusion if the keys look like English strings, but are out of sync with the strings file.</p></li>
<li><p>Keep your English strings in code as the keys. In this case, keep your english strings file empty, and after you run genstrings to create your English strings file for your translators, discard it. We keep an empty english strings file in our repository with a comment in it that lets developers know that it&#8217;s intentionally empty, but I&#8217;m not sure if having an empty English strings file behaves any differently than just not having an English one. The downside to this approach is that modifying your English strings (which are your keys) will cause your strings in other languages not to line up anymore. In cases where the meaning of the string changed, that makes sense. But in cases where you&#8217;re fixing typos or rewording things that wouldn&#8217;t require re-translation, you could be causing extra work for your translators.</p></li>
</ol>


<p>I&#8217;d definitely recommend the second option, leaving the English strings file blank, because it&#8217;ll make development less painful. In the past, I&#8217;ve used the first option and it was no fun to regularly switch back and forth between code and the strings file, or to search for a user-facing string by looking up the key in the strings file. The reason we chose to use the more complicated <code>NSLocalizedStringWithDefaultValue</code> is to prevent changes to English strings breaking the keys for the strings files as would normally happen by using the empty English strings file approach.</p>

<p>We created a macro (with a much shorter name) to minimize our pain with using NSLocalizedStringWithDefaultValue:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#define HTStr(key, value, comment) NSLocalizedStringWithDefaultValue(key, nil, [NSBundle mainBundle], value, comment)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">emailField</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">HTStr</span><span class="p">(</span><span class="s">@&quot;S_Email&quot;</span><span class="p">,</span> <span class="s">@&quot;Email&quot;</span><span class="p">,</span> <span class="s">@&quot;Placeholder for login email field&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this we have the option of changing just the English string, to prevent retranslation and breaking links to existing translations. Or, we can change the key and the value to trigger a retranslation if the meaning of the English string has changed at all. There are a couple downsides to this approach though. Using our macro caused genstrings to not find our strings, so we had to hack together a <a href="https://gist.github.com/raylillywhite/4984291">script for generating our strings file</a>. And you could accidentally use the same key for two different values. Fortunately, this is caught by genstrings:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">Key</span> <span class="s">&quot;S_Email&quot;</span> <span class="n">used</span> <span class="n">with</span> <span class="n">multiple</span> <span class="n">values</span><span class="p">.</span> <span class="n">Value</span> <span class="s">&quot;Email&quot;</span> <span class="n">kept</span><span class="p">.</span> <span class="n">Value</span> <span class="s">&quot;E-mail&quot;</span> <span class="n">ignored</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>In hindsight though, we probably would have been fine with using the simple <code>NSLocalizedString(key, comment)</code>. Smartling makes it pretty easy for us to get our strings files updated by the translators, so if keys were to change anytime we change the English text, that wouldn&#8217;t be a big problem. And you could always selectively use <code>NSLocalizedStringWithDefaultValue</code> in that case.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/lets-stop-making-our-users-type-gmailcom/index.html">Let&#8217;s Stop Making Our Users Type @gmail.com</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-25T00:00:00-08:00" pubdate data-updated="true">Jan 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At HotelTonight, we want our hotel deals to be as accessible as possible to our customers, which means reducing time spent doing tedious things such as signing up and logging in. &nbsp;Accordingly, it occurred to us recently that we could save many of our customer a few seconds if we autocomplete their email domain while they&#8217;re typing. At the time of this writing, over 75% of our customers&#8217; email addresses are from just&nbsp;<em>five</em>&nbsp;domains (gmail.com, yahoo.com, hotmail.com, aol.com, comcast.net). so we should be able to make a pretty accurate educated guess.</p>
<p>Autocompleting email addresses can be tricky to implement because it can easily become distracting and get in the user&#8217;s way. &nbsp;It&#8217;s something that should be completely optional and never overbearing. &nbsp;Therefore, we&#8217;ve come up with a solution that works as follows:</p>
<ol>
<li>Start suggesting an email domain once the user types @</li>
<li>Each time the user types a character after @, re-evaluate the suggestion (i.e. typing &#8220;@h&#8221; yields &#8220;@hotmail.com&#8221;, while &#8220;@hote&#8221; produces &#8220;@hoteltonight.com&#8221;).</li>
<li>Stop suggesting once the user types &#8220;.&#8221; &#8211; to allow subsets of domains to be used. &nbsp;For example, gmail.co instead of gmail.com. &nbsp;Plus, once the user has typed a period we figure they&#8217;re intent on finishing the whole thing, so we&#8217;d like to get out of their way.</li>
</ol>
<p>The first email address that appears after the user types @ is @gmail.com, which means that a full third of our users won&#8217;t have to finish the &#8220;gmail.com&#8221; part. &nbsp;For them, the days of fat fingering &#8220;@gmail.con&#8221; are over.</p>
<p>Our solution relies on&nbsp;<a href="https://github.com/hoteltonight/HTAutocompleteTextField">HTAutocompleteTextField</a>, which can be used to autocompletion any type of data in a text field (for example, a URL), as the logic is written by the developer.</p>
<p>We think this is pretty swell, and we&#8217;d love to see this used in every app, because, frankly, we as users are sick of typing &#8220;gmail.com&#8221; over and over again. &nbsp;Check out HTAutocompleteTextField on&nbsp;<a href="https://github.com/hoteltonight/HTAutocompleteTextField" title="Github">Github</a>&nbsp;and the accompanying example for the implementation details. &nbsp;Please let us know any feedback you might have in the Comments section.</p>
<p>Here&#8217;s a preview of how it works in the app, or you can see it live in Hotel Tonight on the <a href="http://www.hoteltonight.com/iphone">App Store</a>:</p>
<p>&nbsp;</p>
<p><img title="HTAutocompleteTextField in action" src="https://raw.github.com/hoteltonight/HTAutocompleteTextField/master/demo.gif" alt="HotelTonight" style="display: block; margin: 10px auto 30px auto;" /></p>
<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/174411869/index.html">Internationalization and Localization - Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-21T00:00:00-08:00" pubdate data-updated="true">Jan 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is part two of our eight part series of posts on our first foray into internationalization and localization.<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong></p>
<ol>
<li>Planning, tools, and process</li>
<li>Rails</li>
<li>Android</li>
<li>iOS</li>
<li>Design/UX</li>
<li>QA</li>
<li>Marketing</li>
<li>Measuring impact</li>
</ol>
<p>All of our server side apps are currently written in Ruby and use the Rails 3 framework. So where did we start? The first thing we did was to identify the major parts of the system that we needed to ensure were internationalized. Here are the big ticket items that we focused on:<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong></p>
<ul>
<li>API responses (that power our mobile apps)</li>
<li>Emails</li>
<li>Web content</li>
<li>Payment/currency support</li>
</ul>
<h2>Remember the golden rule</h2>
<p>When it comes to internationalization, the simplest and most important rule is to separate code and content. If you&rsquo;re using the Rails framework, the place to start is to read the<a href="http://guides.rubyonrails.org/i18n.html"> Rails Internationalization API guide</a>. Out of the box, you get a lot for free. Here are the basic things that we put in place:<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong>&nbsp;<br />1) Drop in the<a href="https://github.com/svenfuchs/i18n"> i18n gem</a><p />2) Locale is set based on the Accept-Language header that is passed in from a client. We leveraged Iain Hecker&rsquo;s<a href="https://github.com/iain/http_accept_language"> http_accept_language</a> gem for this.<p /><span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">if http_accept_language.header.present?<br /> &nbsp;&nbsp;I18n.locale = <br />&nbsp;&nbsp;&nbsp;&nbsp;http_accept_language.compatible_language_from(I18n.available_locales)<br />else<br />&nbsp;&nbsp;I18n.locale = :en<br />end</span><p />3) We centralized all localizable content for our API responses, emails, and web pages into .yml files. We chose to use multiple .yml files to make it easier to manage different types of content. E.g., legal vs. API responses. We created .yml files in <strong>config/locales</strong> with a key for each string and the string. For example:<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong><br /><strong style="font-family: Times; font-size: medium; font-weight: normal;"><span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">fr:</span><br /><span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;"> customer:</span><br /><span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;"> &nbsp;&nbsp;disabled_account: &#8220;Votre compte a &eacute;t&eacute; d&eacute;sactiv&eacute;&#8221;</span><br /></strong><br />when the view renders its content, it&rsquo;ll pull out the correct string based on the locale that&rsquo;s set based on the Accept-Language header passed in by the client.<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong><br /><strong style="font-family: Times; font-size: medium; font-weight: normal;"><span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">I18n.t &#8216;customer.disabled_account&#8217;</span><br /></strong><br />As mentioned in our previous post, once you have the strings centralized in .yml files, we strongly recommend dropping in &ldquo;pseudo translations&rdquo; to ensure that you&rsquo;ve got all of your strings properly internationalized and to clearly see what kind of layout issues you&rsquo;ve got.</p>
<p>[[posterous-content:ogxeEDcjheJEqjwAglhc]]4) For content in our database (e.g., the profile for each hotel), we ended up creating a custom solution. This isn&rsquo;t in shape to open source yet, but here&rsquo;s the general strategy:<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong></p>
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li>Create a module that can be mixed into a given model that has translatable content (attribute)</li>
<li>Set up associations so that a given attribute for a given instance of a model can have translations. There is a locale associated with each translation.</li>
<li>Keep all translations in a single table</li>
<li>Create rake tasks to export/import content for localization and between different environments (i.e., staging vs. production). Include options to filter based on model and locale.</li>
<li>Create reusable elements that make it easy to manage translations in forms</li>
<li>Add a method similar to <span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">I18n.t</span> to look up a translation for a given key (model, instance ID, and attribute name) and locale</li>
</ul>
<p>Note that our database (we use MySQL) was set up to use UTF-8 from the get-go. If you are not using UTF-8, you&rsquo;ll likely need to take on additional work to convert the data to UTF-8 so that you can store and sort content for multiple locales properly.<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong><br /><span style="font-size: small; font-family: Arial; background-color: transparent; vertical-align: baseline;">5) Ensure that strings and API responses format dates, numbers, and currencies properly. Be sure that</span> <span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">I18n.locale</span> is <span style="font-size: small;">set (or explicitly pass the locale as an option to the method) and leverage the following methods.</span><strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /></strong></p>
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li>Date formatting - <span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">I18n.l</span></li>
</ul>
<p>[[posterous-content:emwibxuFhrvvbeGGDmxB]]</p>
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li>Number formatting - <span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">number_with_precision, number_to_percentage, number_with_delimiter</span></li>
<li>Currency formatting -&nbsp;<span style="font-size: 14px; font-family: Courier New; background-color: transparent; vertical-align: baseline;">number_to_currency</span> 
<ul>
<li>NOTE: We went custom on this for explicit control over which currency symbol to display and what precision to use.</li>
</ul>
</li>
</ul>
<p>6) When it comes to sorting, databases can handle sorting text for multiple locales properly, but Ruby struggles. We suggest checking out&nbsp;<a href="https://github.com/jchris/icu4r">ICU4R</a> and/or&nbsp;<a href="http://engineering.twitter.com/2012/08/twittercldr-improving.html">TwitterCLDR</a> for help with sorting in Ruby, as well as, to solve many of the problems above.</p>
<h2>Layout strategies</h2>
<p>Variable length and namely longer strings (e.g., German tends to be 25% longer than English) will most likely cause you at least some layout problems. We&rsquo;ll talk more about strategies for dealing with variable string lengths in our upcoming posts for design/UX, iOS, and Android, but here are a few tips.</p>
<ul>
<li>Allow wrapping. Use truncation and an ellipsis as a fallback. The number of characters to allow before truncating such that things are understandable isn&rsquo;t always consistent so bear that in mind.</li>
</ul>
<p>[[posterous-content:zoioCBmzCnDwtbgAHzpm]]</p>
<ul>
<li>Guide your translators on maximum string length particularly when you need it to be short. If you can provide screenshots for context that&rsquo;s also very helpful.</li>
</ul>
<p>[[posterous-content:DBrmphlvruyuEdGuJmwI]]</p>
<ul>
<li>Avoid text embedded in images. Every time these change or need localization it is more manual (i.e., modify text in a layer in a Photoshop file and then generate the updated image), time consuming, and therefore more costly to handle these. Don&rsquo;t do it.</li>
</ul>
<h2>Add some tests</h2>
<p>Add more test scenarios to sanity check that translations are rendering properly. Pick content that doesn&rsquo;t change frequently otherwise you&rsquo;ll be doing a lot of maintenance on these checks. Don&rsquo;t go too crazy particularly when you are leveraging things like the Rails i18n API which are already tested. Just do enough to give yourself confidence that things are working properly and that no one made a mistake like checking in a .yml file for the wrong locale under the wrong name.<strong style="font-family: Times; font-size: medium; font-weight: normal;"><br /> </strong></p>
<h2>Payment/currency support</h2>
<p>We&rsquo;ve got a custom abstraction layer for managing payments and currency so we&rsquo;re going to go a little light on the guidance here. At a minimum you need to ensure that you&rsquo;re working with a payment gateway that supports multiple currencies (we use<a href="https://www.braintreepayments.com/"> Braintree</a>) and that a particular form of payment supports a given currency. For example, we weren&rsquo;t able to set up AMEX support with Mexican Pesos.</p>
<h2>Other miscellaneous things to factor in</h2>
<p><strong>SMS and Twitter text</strong> - Keep the English as short as possible as staying under 140 (Twitter) or 160 (SMS) characters isn&rsquo;t always easy after it&rsquo;s been translated</p>
<p><strong>Customer support phone numbers</strong> - You may need different phone numbers in different countries to eliminate or minimize costs for customers. This was more painful for us than it sounds. For example, we were able to secure International Freephone Number (ITFN) numbers that worked for a subset of European countries, but not all. We then had to secure local toll-free numbers for specific countries that didn&rsquo;t support ITFN and adjust customer support phone number handling and display in our apps, APIs, and web pages.</p>
<p><strong>Address formats</strong> - Some countries have states/provinces and some do not</p>
<ul>
</ul>
<h2>Key things to remember</h2>
<p>Here are our top two pieces of advice.</p>
<p>1) <strong>Keep your minimum size string to a sentence</strong> - Often times people are tempted to concatenate sub-strings together to get more reuse.<a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself"> DRY</a> is heavily emphasized in Rails, but this is one time where it can cause you problems. A couple simple examples of this are that in different languages words have gender and things may be phrased differently based on quantity.</p>
<ul>
</ul>
<p style="padding-left: 30px;"><span style="text-decoration: underline;"><strong>GOOD FOR LOCALIZATION</strong></span></p>
<p style="padding-left: 30px;">base: &#8220;A city tax of %{tax_amount} will be collected by the hotel at check-in.&#8221;</p>
<p style="padding-left: 30px;">per_person: &#8220;A city tax of %{tax_amount} <strong>per person</strong> will be collected by the hotel at check-in.&#8221;</p>
<p style="padding-left: 30px;">per_night: &#8220;A city tax of %{tax_amount} <strong>per night</strong> will be collected by the hotel at check-in.&#8221;</p>
<p style="padding-left: 30px;">per_person_per_night: &#8220;A city tax of %{tax_amount} <strong>per person per night</strong> will be collected by the hotel at check-in.&#8221;</p>
<p style="padding-left: 30px;"><span style="text-decoration: underline;"><strong>MAY CAUSE YOU PROBLEMS IF YOU TRY TO CONCATENATE</strong></span></p>
<p style="padding-left: 30px;">base: &#8220;A city tax of %{tax_amount}&#8221;</p>
<p style="padding-left: 30px;">per_person: &#8220;per person&#8221;</p>
<p style="padding-left: 30px;">per_night: &#8220;per night&#8221;</p>
<p style="padding-left: 30px;">collected_at_checking: &#8220;will be collected by the hotel at check-in.&#8221;</p>
<p>With legal strings (e.g., privacy policy and terms of service) we went with the largest contiguous chunks of content (typically paragraph) that we could get away with.</p>
<p>2) <strong>Keep layout in your views versus your strings</strong> - This is less true for web views given the way that browsers handle whitespace, but we certainly had cases where emails and the mobile apps relied on spaces in strings for formatting. When you localize the length of your strings will vary and relying on spaces in specific positions is very brittle. It sounds simple, but our reality was that the aesthetic issues due to spaces made up approximately 10% of the issues logged by QA.</p>
<ul>
</ul>
<p>[[posterous-content:FEGrClsdHsApazDiszjl]]</p>
<ul>
</ul>
<h2>More helpful resources</h2>
<ul>
<li><a href="https://github.com/onomojo/i18n-country-translations">i18n-country-translations</a> gem</li>
<li><a href="http://ruby-i18n.org/wiki">Ruby i18n wiki</a></li>
</ul>
<p>As always please let us know if you have more specific questions that we can try to help with. Up next, we&rsquo;ll offer up some specifics about what we had to do for out native Android and iOS apps.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/internationalization-and-localization-plannin/index.html">Internationalization and Localization - Planning, Tools, and Process</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-12T00:00:00-08:00" pubdate data-updated="true">Dec 12<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong style="font-family: Times; font-size: medium; font-weight: normal;"><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Companywide, we are very excited to have recently released support for French, German, Italian, and Spanish in the HotelTonight apps to better serve more people in more places! When it comes to supporting multiple locales, we are really just getting started in many respects. Despite this, we thought we would share some of our experiences from the past 3 months in order to help others better understand what&rsquo;s involved once you decide that you&rsquo;re ready to bring your mobile apps to an international audience.</span><p /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">This will be a eight part series of posts that discuss:</span><br /><ol style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Planning, tools, and process</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Rails</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Android</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">iOS</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Design/UX</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">QA</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Marketing</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Measuring impact</span></li>
</ol><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">With all of that out of the way, let&rsquo;s dive in and talk planning, tools, and process.</span><br />
<h2><span style="font-size: 19px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Planning</span></h2>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">So you want to expand to an international audience, where to start? We&rsquo;re going to limit the scope of what we talk about to be very app-centric. In other words &ldquo;What do you need to worry about that is directly tied to your mobile apps?&rdquo;</span><p /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">When we started on this journey, there wasn&rsquo;t much done.</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Neither the apps nor APIs were internationalized</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We used Unicode (UTF-8 and UTF-16) in all of our apps all the way through so there was no need to add support for nor convert data between character encodings</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">The mobile app screen layouts were not necessarily designed with localized content (longer strings, etc.) in mind</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">As a company, HT had zero translation experience</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We had implemented support for multiple currencies as we&rsquo;d already expanded into Canada, the UK, and the Netherlands</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We had limited customer support staff with the language skills to support the new locales</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We had no full-time QA staff</span></li>
</ul>
<br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">So how&rsquo;d we go about figuring out what to do?</span><br />
<h3><span style="font-size: 16px; font-family: Arial; color: #666666; background-color: transparent; vertical-align: baseline;">Identify tools to help</span></h3>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Internationalization and localization is a solved problem at least to a degree. We absolutely did not want to re-invent the wheel and primarily focused on finding a hosted </span><a href="http://en.wikipedia.org/wiki/Globalization_management_system"><span style="font-size: 15px; font-family: Arial; color: #1155cc; background-color: transparent; vertical-align: baseline;">translation management system</span></a><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"> (TMS) that we could use to localize content. Some key features that we looked for:</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Hosted, affordable solution</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">A tool that would allow either HT staff or vendors to carry out localization work</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">APIs to get content in/out of the system (enables automation)</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Translation memory (including the ability to import/export in TMX format)</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Glossary (including the ability to import/export the data in a format such as CSV)</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Support for Ruby YAML, Android XML, and iOS Strings formats</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Read-only placeholders for inline markup and/or variables</span></li>
</ul>
<br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">We ended up choosing </span><a href="http://www.smartling.com/"><span style="font-size: 15px; font-family: Arial; color: #1155cc; background-color: transparent; vertical-align: baseline;">Smartling</span></a><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"> as the TMS that best fit for our needs. Besides satisfying our core needs they offered some nice features to help support better translation quality like the ability to associate screenshots with strings to give translators better context to translate with.</span><br />
<h3><span style="font-size: 16px; font-family: Arial; color: #666666; background-color: transparent; vertical-align: baseline;">Roughly estimate technical scope</span></h3>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">1) Internationalization</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We estimated and made changes to externalize strings in both the APIs and mobile apps</span></li>
</ul>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">2) Mobile app screen layout</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Once the API and mobile app strings were externalized we generated &ldquo;pseudo&rdquo; translations via Smartling (albeit there are any number of ways to do this). The &ldquo;pseudo&rdquo; translations are fake translations with longer string lengths and preferably a mix of non-ASCII characters. We dropped these in the apps and APIs and filed tickets/stories to address obvious layout issues.</span></li>
</ul>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">3) Web content and emails</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We estimated and made changes to externalize strings in web pages and email</span></li>
</ul>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">4) Internal tools</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">We decided to create an internal tool that allowed us to associate strings and screenshots and then publish those to Smartling. This is something that we&rsquo;ve thought about open sourcing so if you&rsquo;re interested please get in touch with us.</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">For certain types of content such as hotel profiles, a large chunk of the the content isn&rsquo;t reusable. For this situation we opted to extend our admin UI to allow direct translation of this content rather than send it through a TMS.</span></li>
</ul>
<h3><span style="font-size: 16px; font-family: Arial; color: #666666; background-color: transparent; vertical-align: baseline;">Roughly estimate localization scope</span></h3>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Once the strings were externalized, we were able to generate word counts via the TMS. A number that is often used for rough estimates is to assume that a professional translator can translate on the order of 2,000 words/day.</span><p /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">We used the word counts to project costs and a schedule. We staggered the schedule such that strings in the mobile apps and APIs were translated first so that we could begin testing as early as possible.</span><br />
<h3><span style="font-size: 16px; font-family: Arial; color: #666666; background-color: transparent; vertical-align: baseline;">Start hiring help</span></h3>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">We immediately began searching for localization help, multilingual customer support team members, and multilingual QA engineers. We were able to fill these roles in a 1-2 month period.</span><br />
<h2><span style="font-size: 19px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Process</span></h2>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Since this was our first round of support for new locales, we intentionally kept things fairly manual out of the gate. Here&rsquo;s the basic workflow we follow for each round of localization that we complete:</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">From a designated branch in source control for each app, upload the externalized strings to the TMS</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Translate</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Review</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Download the externalized strings from the TMS</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">On a separate source control branch, create a </span><a href="https://help.github.com/articles/using-pull-requests"><span style="color: #1155cc; background-color: transparent; vertical-align: baseline;">pull request</span></a><span style="background-color: transparent; vertical-align: baseline;"> (we use github) for the Android, iOS, and Rails teams to review and merge in localized string updates</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Generate builds (automatically via continuous integration or manually in some cases) once the pull requests are merged in</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Test (at different points this ranges from the product team to the entire company)</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">File bugs as needed</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Rinse, repeat</span></li>
</ul>
<br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">We plan more automation around this process to make it more continuous in the future, but wanted to make sure we had something basic that worked as a starting point.</span><p /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">When we need to adjust translations we search for and update them directly in the TMS. The updated translations are typically then pulled into the apps with the next round of localization.</span><br />
<h2><span style="font-size: 19px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Roles</span></h2>
<span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">Many of the roles here such as designer, engineer, QA engineer, or translator are fairly obvious. One that may not be obvious is the </span><span style="font-size: 15px; font-family: Arial; background-color: transparent; font-weight: bold; vertical-align: baseline;">localization project manager</span><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">. This person is responsible for:</span><br />
<ul style="margin-top: 0pt; margin-bottom: 0pt;">
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Creating and maintaining the style guide and glossary</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Managing the translators including answering any questions such as clarifying the context for a specific string</span></li>
<li style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;"><span style="background-color: transparent; vertical-align: baseline;">Training translators on how to use various tools</span></li>
</ul>
<br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">For us there were additional responsibilities such as soliciting feedback from multilingual team members throughout the company. This is a full-time job! If you are working with a localization service provider you will likely pay for someone to take on at least a chunk of these duties, but if you are doing things in-house be aware that this isn&rsquo;t a side job.</span><p /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">This concludes what we&rsquo;ve got for you around planning, tools, and process. If you have questions or would like more details please don&rsquo;t hesitate to get in touch with us by posting a comment. </span><p /><span style="font-size: 15px; font-family: Arial; background-color: transparent; vertical-align: baseline;">In upcoming posts in the series, we will delve into more specifics for Rails, Android, iOS, design/UX, QA, marketing, and analytics.</span></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/asynchronous-state-aware-component-rasterizat/index.html">State-aware Cached Rasterization in iOS for Epic Performance</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-07T00:00:00-08:00" pubdate data-updated="true">Dec 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Creating custom programmatically-drawn components in iOS is a common problem in iOS design and development. &nbsp;However, the path toward optimization for these components becomes complicated very quickly - and there is a lot of conflicting advice out there. &nbsp;For the most part, people end up applying the CALayer shouldRasterize property as a cure-all for performance issues. &nbsp;However, CA rasterization is only as clever as it can be - it flushes the raster every time an instance is redrawn. &nbsp;Often times, bundled assets are used instead. I think there is a lot of value in building dynamic components rather than filling your app binary with bundled assets, so I decided to dig deeper and develop a more efficient pattern.</p>
<p>I was inspired by two recently published works: <a href="http://robots.thoughtbot.com/post/36591648724/designing-for-ios-graphics-performance" target="_blank">Reda Lemeden&#8217;s article Designing for iOS: Graphics and Performance</a>, and <a href="https://github.com/mindsnacks/MSCachedAsyncViewDrawing">Javier Soto&#8217;s MSCachedAsyncViewDrawing library</a>.</p>
<p>The main point of inspiration from Reda&#8217;s article was what he called a &#8216;hybrid approach&#8217; - essentially, using the iOS drawing stack to render image assets on the <em>component level</em>&nbsp;as static UIImages. &nbsp;At it&#8217;s core, this is very similar to rasterization, except that the generated image is drawn only once and stored in a shared location, instead of Core Animation storing a bitmap of <em>each rendered instance</em> of your component. &nbsp;This works great for components that are static in nature, but what about more complex components that having many properties affecting their appearance?</p>
<p>This question drove&nbsp;the development of a class called <a href="https://github.com/hoteltonight/HTStateAwareRasterImageView">HTStateAwareRasterImageView</a>, a rasterization system that caches rendered components based on their state, rendering new assets in response to key-value observation of developer-defined key paths affecting appearance. &nbsp;A component&#8217;s unique state, based on the values of it&#8217;s properties that affect appearance, is only ever drawn once in this system. Asynchronous rendering is an added bonus, thanks to MSCachedAsyncViewDrawing. The bundled demo project compares the same component in a table using no rasterization, Core Animation rasterization, and HTStateAwareRasterImageView, demonstrating a dramatic performance enhancement, especially on older devices (I&#8217;m testing using a 4th gen iPod). The usage looks like this, from the github readme:</p>
<p>Start by conforming to the HTRasterizableView protocol. A simple example is provided in the demo project (HTExampleRasterizableComponent). The single required method is:</p>
<div class="CodeRay">
  <div class="code"><pre>- (NSArray *)keyPathsThatAffectState;</pre></div>
</div>

<p>This is used for two purposes:&nbsp;</p>
<ul>
<li>To key-value observe the specified key paths to trigger image regeneration&nbsp;</li>
<li>To generate a hash of the component&#8217;s state</li>
</ul>
<p>Initialize a HTStateAwareRasterImageView and set the rasterizableView property to your HTRasterizableView, like this snippet from the demo project:</p>
<div class="CodeRay">
  <div class="code"><pre>_rasterizableComponent = [[HTExampleRasterizableComponent alloc] init];
_stateAwareRasterImageView = [[HTStateAwareRasterImageView alloc] init];
_stateAwareRasterImageView.rasterizableView = _rasterizableComponent;
_stateAwareRasterImageView.delegate = self;
[self addSubview:_stateAwareRasterImageView];</pre></div>
</div>

<p>If your component can take advantage of UIImage caps (fixed-size corners and stretchable center), these two methods are optional on the HTRasterizableView protocol:&nbsp;</p>
<div class="CodeRay">
  <div class="code"><pre>- (UIEdgeInsets)capEdgeInsets;
- (BOOL)useMinimumFrameForCaps;</pre></div>
</div>

<p>If you respond YES to userMinimumFrameForCaps, the component is rendered at it&#8217;s cumulative cap sizes plus 1pt horizontally and vertically, drastically reducing render time in many applications.</p>
<p>You can specify if you want drawing to occur synchronously on the main thread:</p>
<div class="CodeRay">
  <div class="code"><pre>@property (nonatomic, assign) BOOL drawsOnMainThread;</pre></div>
</div>

<p>You can also turn off keypath observing if you want to manually regenerate images (use this for pre-rendering assets):</p>
<div class="CodeRay">
  <div class="code"><pre>@property (nonatomic, assign) BOOL kvoEnabled; 
// For prerendering only
- (void)regenerateImage:(HTSARIVVoidBlock)complete;</pre></div>
</div>

<p>A delegate property is also available to let you know when it&#8217;s regenerating an image, and when it gets a new image back:</p>
<div class="CodeRay">
  <div class="code"><pre>@property (atomic, assign) id&lt;HTStateAwareRasterImageViewDelegate&gt; delegate;</pre></div>
</div>

<p>For debugging purposes, the cache&nbsp;key is available through this method.</p>
<div class="CodeRay">
  <div class="code"><pre>- (NSString *)cacheKey;</pre></div>
</div>

<p>The demo project has four tabs:</p>
<ul>
<li>A tableview taking advantage of HTStateAwareRasterImageView</li>
<li>A tableview that displays cache key, actual size and cell-height sized cached images</li>
<li>A tableview that uses the same component without rasterization</li>
<li>A tableview that uses the same component with Core Animation rasterization enabled</li>
</ul>
<p>[[posterous-content:kalFFJyEvoqgGhuifDna]][[posterous-content:rbkatumnjpxwdsCvplev]]</p>
<ul>
</ul>
<p>&nbsp;</p>
<p>The cache key used to define the state of your component is generated by the NSObject+HTPropertyHash category. It is important that the hash method produces a string that is unique to the state of your properties, but not TOO unique by including things like pointer values. The exception for CGColorRef in that category is made because we only want the RGBA values described, not the pointer value&nbsp;plus the RGBA values. &nbsp;Other exceptions may be required, depending on the application.</p>
<p>A limitation of this approach (and all approaches that render CALayers to image contexts) is that CALayer renderInContext, used for drawing the layer to a graphics context, does not support the CALayer mask property, as well as some other exceptions. &nbsp;The category included in the project, UIView+HTDrawInContext, provides a workaround for CALayer masks, but <em>only for the root layer of the rasterized component.</em>&nbsp;From the CALayer doc,</p>
<p>&#8220;&#8230;&nbsp;this method does not support the entire Core Animation composition model.&nbsp;<code>QCCompositionLayer</code>,&nbsp;<code>CAOpenGLLayer</code>, and&nbsp;<code>QTMovieLayer</code>&nbsp;layers are not rendered. Additionally, layers that use 3D transforms are not rendered, nor are layers that specify&nbsp;<code><a href="https://developer.apple.com/library/mac/documentation/graphicsimaging/reference/CALayer_class/Introduction/Introduction.html#//apple_ref/occ/instp/CALayer/backgroundFilters">backgroundFilters</a></code>,&nbsp;<code><a href="https://developer.apple.com/library/mac/documentation/graphicsimaging/reference/CALayer_class/Introduction/Introduction.html#//apple_ref/occ/instp/CALayer/filters">filters</a></code>,<code><a href="https://developer.apple.com/library/mac/documentation/graphicsimaging/reference/CALayer_class/Introduction/Introduction.html#//apple_ref/occ/instp/CALayer/compositingFilter">compositingFilter</a></code>, or a&nbsp;<code><a href="https://developer.apple.com/library/mac/documentation/graphicsimaging/reference/CALayer_class/Introduction/Introduction.html#//apple_ref/occ/instp/CALayer/mask">mask</a></code>&nbsp;values. Future versions of OS X may add support for rendering these layers and properties.&#8221;</p>
<p>If you decide to give <a href="https://github.com/hoteltonight/HTStateAwareRasterImageView">HTStateAwareRasterImageView</a> a try, pull requests and feedback are very welcome (submit an issue on github). Good luck!</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/handling-multiple-delegates-in-ios/index.html">Handling Multiple Delegates in iOS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-24T00:00:00-07:00" pubdate data-updated="true">Oct 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes, the delegate pattern in iOS just doesn&#8217;t fit with a class heirarchy or design, specifically when you find yourself wanting to assign multiple delegates to a single source. For these cases, the approach usually taken is to use the notification center. This is an approach I have used in the past, but it always felt like a cop-out. Instead, I decided to build a delegate proxy using an NSProxy subclass. It takes a list of target delegates, and operates on two simple rules:</p>
<ol>
<li>Messages with a void return type are sent to all target delegates</li>
<li>Messages with non-void return types are send to the <em>first delegate in the list which responds to the selector.</em></li>
</ol>
<p>This pattern seems to be effective in identifying which messages are informative (hey, something happened) and which messages are more complex interactions (how should I do this?). It worked well for my use case (UIScrollViewDelegate), and I&#8217;m really curious to see how well it works for other applications. Comment if you find some use for it! &nbsp;Podspec included for CocoaPods users.</p>
<p><a href="https://github.com/hoteltonight/HTDelegateProxy" title="HTDelegateProxy on GitHub" target="_blank">The class HTDelegateProxy is available here on GitHub.</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/capturing-global-hotkeys-in-the-ios-simulator/index.html">Capturing Global Hotkeys in the iOS Simulator</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-08T00:00:00-07:00" pubdate data-updated="true">Oct 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Why would you want to do that?</strong></p>
<p>When you&#8217;re using an iterative workflow, little shortcuts make a big difference. &nbsp;Having the ability to use custom hotkeys on the keyboard while the app runs in the simulator turns out to be very useful. &nbsp;Being able to navigate to specific screens with a hotkey can save a lot of time when you&#8217;re making small changes and restarting over and over. &nbsp;Our first application was triggering screenshot captures for a localization tool called Smartling. &nbsp;I think it will be useful in debugging edge cases where we need to trigger uncommon events in code. &nbsp;What would you use it for? &nbsp;Check out the code at:</p>
<p><a href="https://github.com/jacobjennings/JJPrivateKeyEvents">https://github.com/jacobjennings/JJPrivateKeyEvents</a>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/killing-stale-or-stuck-resque-jobs/index.html">Killing Stale or Stuck Resque Jobs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-17T00:00:00-07:00" pubdate data-updated="true">Aug 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We use Resque (<a href="https://github.com/defunkt/resque)">https://github.com/defunkt/resque)</a> for processing our background jobs in Rails. We initially implemented Resque to send a few emails, but have since expanded our use greatly.</p>
<p>As we&#8217;ve begun relying more on Resque for all aspects of our app, we will occasionally experience long running jobs that get stuck. We know the job has finished  (an email was sent or a file was generated), but the job holds on to the worker and clogs our queue. Here is our method for killing the stuck jobs and getting our queue going again.</p>
<p></div>
  
  
    <footer>
      <a rel="full-article" href="/raylillywhitehtblog/killing-stale-or-stuck-resque-jobs/index.html">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/writing-android-unit-tests-with-robolectric/index.html">Writing Android Unit-Tests With Robolectric</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-23T00:00:00-07:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Until recently, I&rsquo;ve been unable to configure a <a href="http://pivotal.github.com/robolectric/" title="Robolectric" target="_self">Robolectric</a> project that can easily be shared across a team and integrated with <a href="http://jenkins-ci.org/" title="Jenkins CI" target="_self">Jenkins CI</a> without the use of Maven. I mentioned this in a previous post, and have asked for assistance on Pivotal&rsquo;s <a href="http://groups.google.com/group/robolectric?pli=1" title="Robolectric Google Group" target="_self">Robolectric Google Group</a> a handful of times. There are several jar files that need to be referenced, and dependencies between the test and main Android projects and (without the use of Maven) this is difficult to configure and move around between teammates.</p>
<p>Read on at <a href="http://publicstaticdroidmain.com/2012/03/robolectric-ant-project-eclipse/" title="Android Development Blog" target="_self">Public Static Droid Main</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/raylillywhitehtblog/working-with-credit-cards-in-hoteltonight-for/index.html">Working With Credit Cards in HotelTonight for iPad</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-03T00:00:00-07:00" pubdate data-updated="true">Apr 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you haven&rsquo;t heard, we <a href="http://itunes.apple.com/us/app/hotel-tonight-last-minute/id407690035?mt=8">released an iPad app</a>. It&rsquo;s pretty good too. We were confronted with quite a few interesting and unique challenges in bringing our iPhone app to the much larger screen of the iPad. Just blowing everything up so that the existing phone app used the entirety of the iPad&rsquo;s screen wasn&rsquo;t good enough. We needed to start with a blank slate and rebuild everything from scratch to make a true iPad experience that we could be proud of.</p>

<p>One area that received quite a bit of attention was the interface for entering and selecting a credit card to use during a booking. Since we sell a physical good (a hotel room reservation), we don&rsquo;t use the in-app purchase frameworks that Apple provides for allowing upgrades and other purchases in the other apps you love.</p>

<p>The problem with credit card input is that no one enjoys doing it. It&rsquo;s a utilitarian chore entering a string of numbers, an expiration date and a CVV whether you&rsquo;re on the desktop or mobile. Our primary goal with creating this new card entry experience was to make it not only easy to use, but also fun.</p>

<p>For comparisons sake, this is what we started with on the iPhone:</p>

<p><img src="http://getfile0.posterous.com/getfile/files.posterous.com/temp-2012-04-03/xGawDAvBDvsJtshiyatAHecrDBByEEoomozeyAnkknelEycjgmlfovgtvAqh/iphone_cards.png" alt="iPhone Card Entry" /></p>

<p>Certainly a serviceable UI, but not something that we wanted to just import into the iPad UI. For one, having a full size table view in the middle of our booking workflow would look strangely out of place. Second, we tried really hard to minimize the number of popovers in the interface. Popovers are useful for supplemental information, but providing them as part of the main workflow in the app wouldn&rsquo;t be a fit for the experience we were trying to provide our users.</p>

<h2>Research/Inspiration</h2>

<p>Before we went down the path of building our own card implementation, we spent some time downloading different mobile apps and seeing how they did credit card entry. The first place to look of course is at our friends at <a href="http://squareup.com">Square</a>. A company built around taking mobile payments is an easy place to look. We also were incredibly impressed by our same day booking buddies at <a href="https://www.getwillcall.com/">WillCall</a>. Their entire app is impressive, but their card entry UI is what caught our eye the most.</p>

<p>What both Square and WillCall have in common is the single-line entry paradigm. Once you enter a credit card number, your cursor automatically shifts to the next field, followed by the next until you&rsquo;re ready to submit. There is inline validation along the way to ensure the user isn&rsquo;t hitting the authentication servers with obviously bad data such as an expired card or an invalid card number.</p>

<h2>What We Ended Up With</h2>

<p>For the first version of HotelTonight for iPad, this is what we shipped:</p>

<p><img src="http://getfile9.posterous.com/getfile/files.posterous.com/temp-2012-04-03/avozleyDqeElcedGGsahpcEbfvFpvggDnpjkEAdwGGqIEJpeweIjnqtGIDDa/card1.png" alt="Card Entry State" /></p>

<p>There are three states to our card selection user interface:</p>

<ol>
<li>The card entry state (above)</li>
<li>The card validation state (below)</li>
<li>The card selection state (the screenshot below that).</li>
</ol>


<p>The card entry state has two fields: the card number and card expiration. The card number field is just a vanilla <code>UITextField</code>, but we do a bit of massaging of the input as the user types. Most noteably, we have a <code>UITextFieldTextDidChangeNotification</code> handler attached that does three things:</p>

<ol>
<li>Ensure that we have a valid length card number</li>
<li>Ensure that the card number matches the type of cards we support: Visa, MasterCard, American Express and Discover.</li>
<li>Ensure the card passes a <a href="http://en.wikipedia.org/wiki/Luhn_algorithm">luhn validation</a></li>
</ol>


<p>If the card number is validated, we automatically transition the user to the expiration date field so they can continue typing. No need to tap a next button or manually tap on the expiration field. Upon entering a successful expiration date, we transition to the  validation state.</p>

<p><img src="http://getfile4.posterous.com/getfile/files.posterous.com/temp-2012-04-03/CDtAFgCwzpGjHudBsCpmwErjAcaAhgonFxpuvsfepidhxIxafaJJGwDgmsJD/card2.png" alt="Card Validation State" /></p>

<p>The validation state transition is where we highlight what type of card the user has entered as well as providing the last four digits of their card number. Tapping on either of those transitions back to the card entry state. The user can also backspace from the CVV field to get back there. More on that later.</p>

<p>Once a card is entered, it shows in in our credit card tray.</p>

<p><img src="http://getfile9.posterous.com/getfile/files.posterous.com/temp-2012-04-03/BGydlczksqviHpqIvpnJDFrgztHtyAjFHoeAaxvvtJqAbbfqHejDsCFyhrjj/card3.png" alt="Card Selection State" /></p>

<p>The currently selected card has a full-color treatment while the others are desaturated. If you have more than a few cards, the picker turns into a scrollable control that lets you choose between the different ones.</p>

<h2>The Little Details</h2>

<p>We obsess over the little details at HT. The first time we played with a functional implementation of the card picker control, we were annoyed that deleting the last character in a text field didn&rsquo;t push back to the previous text field or picker state. It turns out this isn&rsquo;t as easy as we had hoped.</p>

<p>Whenever you make a change to a <code>UITextField</code>, you have the opportunity to perform an action using the <code>- textField:shouldChangeCharactersInRange:replacementString:</code> delegate method. Unfortunately it is not called if there are no characters in a text field. To work around this, we decided to insert a zero width space (\u200B for the Unicode fans in the house) at the beginning of each text field. <code>UITextField</code> won&rsquo;t render the space, but it is capable of being deleted, and subsequently firing our delegate method. We then check if the delete key is being pressed while the text field only contains that zero width space. If it is, we transition to the previous field.</p>

<h2>Things We Waffled Over</h2>

<p>In the run-up to shipping our shiny new iPad app, we gave everyone in the office an opportunity to test out the application. Tests like this are always eye opening because developer eyes tend to glaze over after staring at the same piece of functionality for days and weeks on end. We miss stuff, or assume other things are more obvious than they really are.</p>

<p>The first thing our user tests uncovered was that people didn&rsquo;t know what to do with the card picker in its default selection state if they didn&rsquo;t have any cards already associated with their account. To alleviate this, we default to showing the picker to the user in its card entry state if there are no credit cards associated with the currently logged in user.</p>

<p>We also decided to add a bit of help text underneath each the entry fields to further guide the user along. Each text field has placeholder text, but in the case of fields like CVV we were concerned some users might not know what a CVV was. The help text offers a bit of guidance.</p>

<h2>Moving Forward</h2>

<p>As with all things software, we have a few ideas of how we want to enhance the card picker going forward. For one, users can&rsquo;t currently edit or delete cards. There are also some additional treatments and animations we&rsquo;d like to add to the card tray as you transition from the selection state into the new card input.</p>

<p>You can check out the  card picker in action by downloading our new iPad app <a href="itunes">on the App Store</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/raylillywhitehtblog/blog/page/2/">&larr; Older</a>
    
    <a href="/raylillywhitehtblog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/raylillywhitehtblog/blog/2013/02/18/the-nitty-gritty-of-ios-internationalization-and-localization/">The Nitty Gritty of iOS Internationalization and Localization</a>
      </li>
    
      <li class="post">
        <a href="/raylillywhitehtblog/lets-stop-making-our-users-type-gmailcom/index.html">Let&#8217;s stop making our users type @gmail.com</a>
      </li>
    
      <li class="post">
        <a href="/raylillywhitehtblog/174411869/index.html">Internationalization and localization - Rails</a>
      </li>
    
      <li class="post">
        <a href="/raylillywhitehtblog/internationalization-and-localization-plannin/index.html">Internationalization and localization - Planning, tools, and process</a>
      </li>
    
      <li class="post">
        <a href="/raylillywhitehtblog/asynchronous-state-aware-component-rasterizat/index.html">State-aware cached rasterization in iOS for epic performance</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
